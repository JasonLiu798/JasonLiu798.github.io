	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-EN" lang="en-EN">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.15" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> 防火墙的坑 &middot; JasonLiu&#39;s Blog </title>

  
  <link rel="stylesheet" href="http://jasonliu798.github.io/css/poole.css">
  <link rel="stylesheet" href="http://jasonliu798.github.io/css/syntax.css">
  <link rel="stylesheet" href="http://jasonliu798.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="JasonLiu&#39;s Blog" />
</head>

	<body class="">
		<div class="sidebar">
  <div class="container sidebar-sticky">

    <div class="sidebar-about">
      <a href="http://jasonliu798.github.io/"><h1>JasonLiu&#39;s Blog</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
        <li><a href="/"> JasonLiu&#39;s Blog </a></li>
      
        <li><a href="https://www.google.com/search?q=andrew&#43;ridgeley"> The other guy from Wham! </a></li>
      
        <li><a href="https://www.github.com"> This theme - add link </a></li>
      
    </ul>

    <p>&copy; 2016. All rights reserved. </p>
  </div>
</div>


		<div class="content container">
			<div class="post">
			 	<h1>防火墙的坑</h1>
			  <span class="post-date">Sun, Mar 20, 2016</span>

				<ul>
				
				
				</ul>

			      <p>周末晚上，正在家里辐射4玩着正爽，网站突然挂站，前台502，赶忙登服务器，排查原因。</p>

<p>网站架构是php通过socket，hessian协议调用，java写的一个proxy，通过hessian协议把php解析为java object，通过dubbo client rpc调用dubbo服务。
排查后台的dubbo服务并未发现异常，但是日志刷新速度貌似比平常要慢一点。</p>

<p>经运维重启php，dubbo服务后，暂时缓解了问题，不到1个小时，前台再次502。
然后，开始排查各种日志，无奈本业务线的一个bug由于暂时未解决撞到枪口，虽然跟本次挂站无任何联系，也被叫到公司去改bug，无比蛋疼。</p>

<p>根据Zabbix监控，发现proxy的流量先是有锯齿状抖动，然后流量锯齿状下跌到0，重启完服务后，连接数锯齿状抖动，TCP连接图中tcp.ESTAB情况类似，tcp.CLOSING却是一条流量很低的横线。但据运维检查网络并未发现问题。</p>

<p>之后持续了半小时，流量突然恢复正常，原来运维把iptables关了，排查发现有人在8点通过主控机，执行了开启iptables的脚本，使用了默认设置，路由表的数量超过65535，拒绝数据传输。</p>

			</div>

			
		</div>

  </body>
</html>
